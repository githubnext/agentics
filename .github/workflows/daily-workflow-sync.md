---
on:
  schedule:
    - cron: "0 13 * * 1-5"  # Daily at 1 PM UTC, weekdays only
  workflow_dispatch:

permissions: read-all

timeout-minutes: 30

network:
  allowed:
    - node
    - raw.githubusercontent.com

steps:
  - name: Checkout repository
    uses: actions/checkout@v4
    with:
      fetch-depth: 0

  - name: Install gh-aw extension
    run: gh extension install githubnext/gh-aw || gh extension upgrade githubnext/gh-aw
    env:
      GH_TOKEN: ${{ github.token }}

tools:
  github:
    allowed:
      - search_pull_requests
      - pull_request_read
      - get_file_contents
      - list_commits
  web-fetch:
  bash:
    - "*"

safe-outputs:
  jobs:
    sync-workflows:
      description: "Sync workflow files and create/update pull request"
      runs-on: ubuntu-latest
      permissions:
        contents: write
        pull-requests: write
      output: "Workflow sync completed"
      inputs:
        workflows_data:
          description: "JSON data containing workflow files to sync"
          required: true
          type: string
        pr_branch:
          description: "Branch name for the pull request"
          required: true
          type: string
        pr_exists:
          description: "Whether an existing PR was found"
          required: true
          type: string
        pr_number:
          description: "Existing PR number (empty if new)"
          required: false
          type: string
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
            token: ${{ secrets.GITHUB_TOKEN }}

        - name: Configure Git
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

        - name: Setup branch
          env:
            PR_EXISTS: ${{ inputs.pr_exists }}
            PR_BRANCH: ${{ inputs.pr_branch }}
          run: |
            if [ "$PR_EXISTS" = "true" ]; then
              echo "Checking out existing PR branch: $PR_BRANCH"
              git fetch origin "$PR_BRANCH"
              git checkout "$PR_BRANCH"
              git pull origin "$PR_BRANCH"
            else
              echo "Creating new branch: $PR_BRANCH"
              git checkout -b "$PR_BRANCH"
            fi

        - name: Write workflow files
          env:
            WORKFLOWS_DATA: ${{ inputs.workflows_data }}
          run: |
            echo "$WORKFLOWS_DATA" | jq -r '.workflows[] | @json' | while read -r workflow; do
              path=$(echo "$workflow" | jq -r '.path')
              content=$(echo "$workflow" | jq -r '.content')
              
              # Create directory if needed
              mkdir -p "$(dirname "$path")"
              
              # Write the file
              echo "$content" > "$path"
              echo "âœ… Written: $path"
            done

        - name: Commit and push changes
          env:
            PR_EXISTS: ${{ inputs.pr_exists }}
            PR_BRANCH: ${{ inputs.pr_branch }}
          run: |
            # Stage only .md files, not .lock.yml
            git add workflows/*.md workflows/shared/*.md 2>/dev/null || true
            
            # Check if there are changes
            if git diff --staged --quiet; then
              echo "No changes to commit"
              echo "CHANGES=false" >> $GITHUB_ENV
            else
              echo "Changes detected, committing..."
              git commit -m "chore: sync workflows from githubnext/gh-aw"
              git push -u origin "$PR_BRANCH"
              echo "CHANGES=true" >> $GITHUB_ENV
            fi

        - name: Create or update PR
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            PR_EXISTS: ${{ inputs.pr_exists }}
            PR_NUMBER: ${{ inputs.pr_number }}
            PR_BRANCH: ${{ inputs.pr_branch }}
            WORKFLOWS_DATA: ${{ inputs.workflows_data }}
          run: |
            if [ "${CHANGES}" = "false" ]; then
              echo "âœ… No changes needed - workflows are in sync"
              exit 0
            fi
            
            WORKFLOW_COUNT=$(echo "$WORKFLOWS_DATA" | jq '.workflows | length')
            
            cat > /tmp/pr-body.md << 'EOF'
            ## ðŸ”„ Automated Workflow Sync
            
            This PR synchronizes workflow files from [githubnext/gh-aw](https://github.com/githubnext/gh-aw).
            
            ### Changes
            - Updated/added workflow file(s)
            - Excluded `.lock.yml` files (will be generated on merge)
            
            ### Source
            - Repository: `githubnext/gh-aw`
            - Directory: `.github/workflows/`
            
            ðŸ¤– This PR was automatically generated by the daily-workflow-sync workflow.
            EOF
            
            if [ "$PR_EXISTS" = "true" ]; then
              echo "Updating existing PR #$PR_NUMBER"
              gh pr comment "$PR_NUMBER" --body "ðŸ”„ Updated with latest changes from githubnext/gh-aw at $(date -u +%Y-%m-%d\ %H:%M\ UTC)"
            else
              echo "Creating new pull request"
              gh pr create \
                --title "[auto-update] Sync workflows from gh-aw" \
                --body-file /tmp/pr-body.md \
                --head "$PR_BRANCH" \
                --base main
            fi

engine: copilot
---

# Daily Workflow Sync from githubnext/gh-aw

You are an automated workflow synchronization agent. Your job is to keep the workflows in this repository (`${{ github.repository }}`) in sync with the latest workflows from the `githubnext/gh-aw` repository.

## Your Mission

Follow these steps carefully to synchronize workflows:

### 1. Check for existing pull request

Search for an open pull request with title starting with `[auto-update]`:
- Use the GitHub `search_pull_requests` tool with query: `repo:${{ github.repository }} is:pr is:open "[auto-update]" in:title`
- If found, extract the PR number and branch name (from `head.ref`)
- Store these for later use

### 2. Fetch workflows from githubnext/gh-aw

Get the list of all workflow files from the upstream repository:
- Use GitHub tool to get contents of `githubnext/gh-aw` at path `.github/workflows/`
- Filter for files ending in `.md` (these are agentic workflow source files)
- Exclude any `.lock.yml` files (these are generated artifacts)
- Also check for the `.github/workflows/shared/` directory and list any shared workflows

### 3. Compare with local workflows

Check what's already in this repository:
- Use bash to list files in `workflows/` directory: `ls -1 workflows/*.md`
- Also list shared workflows: `ls -1 workflows/shared/*.md` if the directory exists
- Compare the lists to identify:
  - New workflows that exist in gh-aw but not locally
  - Existing workflows that might need updates

### 4. Fetch workflow content

For each workflow file you want to sync:
- Use GitHub tool `get_file_contents` to fetch from `githubnext/gh-aw` repository
- Path: `.github/workflows/<workflow-name>.md`
- Parse the frontmatter to check for any `imports:` field
- If imports are present, fetch those shared workflow files too from `.github/workflows/shared/`
- Store all the content you fetch

### 5. Prepare data for safe output job

Create a JSON structure with all the workflows you fetched:
```json
{
  "workflows": [
    {
      "path": "workflows/example-workflow.md",
      "content": "---\non: issues\n---\n# Workflow content..."
    },
    {
      "path": "workflows/shared/common.md",
      "content": "---\n# Shared workflow..."
    }
  ]
}
```

### 6. Determine branch name

Based on whether a PR exists:
- If PR exists: use the existing branch name from step 1
- If no PR: generate a branch name like `auto-update/sync-workflows-YYYYMMDD` using today's date

### 7. Call the safe output job

Invoke the `sync-workflows` safe output job with:
- `workflows_data`: The JSON structure from step 5 (as a string)
- `pr_branch`: The branch name from step 6
- `pr_exists`: "true" or "false" string
- `pr_number`: The PR number if it exists, empty string otherwise

The safe output job will:
- Create or checkout the branch
- Write all the workflow files
- Commit and push (excluding .lock.yml files)
- Create a new PR or update the existing one

## Important Guidelines

- **Focus on workflow comparison**: Your job is to analyze and prepare the data
- **Don't manually write files**: The safe output job handles all file operations
- **Be selective**: Only sync workflows that are relevant for this repo
- **Preserve metadata**: When fetching workflows, preserve their exact content
- **Handle dependencies**: If a workflow imports shared files, include them in your JSON
- **Use exact paths**: Local path format is `workflows/<name>.md`, not `.github/workflows/<name>.md`

## Example Workflow Selection

Consider syncing workflows like:
- General-purpose automation workflows (triage, maintenance, etc.)
- Example workflows that demonstrate gh-aw features
- Shared workflow components that others might import

Skip workflows that are:
- Specific to the gh-aw repository itself
- For internal testing only
- Not applicable to general users

## Error Handling

- If a workflow fails to fetch, log it and continue with others
- If no workflows need syncing, that's success - just report it
- If the safe output job fails, the error will be visible in the job output

## Context

- Current repository: `${{ github.repository }}`
- Date: Run at 1 PM UTC on weekdays
